app.controller("Payment",["$scope","$localStorage","$sessionStorage","$http","$cookies","Stripe",function(a,b,c,d,e,f){0===b.cartCount&&(window.location.href="/store/cart"),d.get("/api/product").success(function(c){for(var g in c)for(var h in c[g])"Category"===h&&(c[g].CategoryName=c[g][h].CategoryName,delete c[g].Category);a.products=c,a.cart=b.cartItems,a.getProduct=function(b){var c=_.find(a.products,function(a){return b==a.ProductID?!0:void 0});return c},a.getTotal=function(){a.total=0,a.shipping=15;for(var b in a.cart){var c=a.getProduct(b);a.total=a.total+c.ProductPrice*a.cart[b].count}a.subtotal=a.total,a.tax=.08875*a.total,a.total=a.total+a.tax+a.shipping},a.getTotal();var i=null;e.get("User")&&(a.account=JSON.parse(e.get("User").substring(e.get("User").indexOf("{"),e.get("User").lastIndexOf("}")+1)),i=a.account.UserEmail);var j=StripeCheckout.configure({key:f.key,locale:"auto",email:i,allowRememberMe:!1,token:function(c){d.post("/store/cart/charge",{address:{Save:$("#UserAddressSave").val(),UserAddressFullName:$("#UserAddressFullName").val(),UserAddressStreet:$("#UserAddressStreet").val(),UserAddressCity:$("#UserAddressCity").val(),UserAddressState:$("#UserAddressState").val(),UserAddressZip:$("#UserAddressZip").val()},token:c,items:b.cartItems,total:Math.round(100*a.total)/100,subtotal:Math.round(100*a.subtotal)/100,shipping:Math.round(100*a.shipping)/100,tax:Math.round(100*a.tax)/100}).success(function(a){b.cartCount=0,b.cartItems={},window.location="/store/cart/confirmation/"+a}).error(function(a){console.log(a)})}});$("#paymentButton").on("click",function(b){j.open({name:"Tweedles Bakery",amount:Math.round(100*a.total)}),b.preventDefault()}),$(window).on("popstate",function(){j.close()})}).error(function(a){console.log(a)})}]);